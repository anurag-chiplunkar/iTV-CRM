{% extends "base2.html" %}
{% load crispy_forms_tags %}
{% block container %}

<u><h3>AFP Deal Details</h3></u>
<body>
<form class="form-horizontal" method="POST" id = "afp_form" action="" url="{% url 'afp_deal:afp_deal_load_br' %}" >
    {% csrf_token %}
{{ formset.management_form }}
{% for form in formset %}

<!-- creating rows -->
<div class="row form-row spacer">
   
    <div class="col-4">
        <div class="input-group" >
            {{form.afp_deal_id | as_crispy_field}}
            
        </div>
    </div>
</div>

<!-- assign all the columns of formset to container -->

<div class="container1">
    <hr>
    <div class="row form-row spacer">
      
        <div class="col-3">
            <div class="input-group form-select col-auto ">
                {{form.ref_program_name | as_crispy_field}}
                
            </div>
        </div>
        <div class="col-3">
            <div class="input-group form-select col-auto">
                {{form.ref_channels | as_crispy_field}}
                
            </div>
        </div>
        <div class="col-3" id="div_duration">
            <div class="input-group form-select col-auto class_durations">
                {{form.ref_promos | as_crispy_field}}  
            </div>
        </div>
        <div class="col-3" id="div_duration_in">
            <div class="input-group form-select col-auto class_duration_in">
                {{form.ref_slot | as_crispy_field}}
                
            </div>
        </div>
        
    </div>

<div class="row form-row spacer">
   
    <div class="col-3" id="div_effective_rate">
        <div class="input-group">
            {{form.afp_eff_rate | as_crispy_field}}
            
        </div>
    </div>
    <div class="col-3">
        <div class="input-group">
            {{form.afp_base_rate | as_crispy_field}}
        </div>
    </div>
</div>
</div>


<hr>
{% endfor %}

<!-- Adding buttons -->
<div class="row spacer">
    <div class="input-group-append">
        <button class="btn btn-success add-form-row">Add Another Element</button>
    </div>
    <div class="col-4 offset-2">
        <button type="submit" class="btn btn-block btn-primary">Create</button>
    </div>
</div>

</form>
{% endblock %}


<!-- Handles new form instance -->
{% block custom_js %}
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript">
 var count = 0;
function updateElementIndex(el, prefix, ndx) {
    var id_regex = new RegExp('(' + prefix + '-\\d+)');
    var replacement = prefix + '-' + ndx;
    if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
    if (el.id) el.id = el.id.replace(id_regex, replacement);
}
var list_id = []
function cloneMore(selector, prefix) {
    
    var newElement = $(selector).clone(true);
    console.log(newElement, 'newElement')
    var total = $('#id_' + prefix + '-TOTAL_FORMS').val();

    newElement.find(':input:not([type=button]):not([type=submit]):not([type=reset])').each(function() {
        var name = $(this).attr('name')
        
        if(name) {
            name = name.replace('-' + (total-1) + '-', '-' + total + '-');
            var id = 'id_' + name;
            list_id.push(id)
            $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
        }
    });
    console.log(list_id)

    newElement.find('label').each(function() {
        var forValue = $(this).attr('for');
        if (forValue) {
          forValue = forValue.replace('-' + (total-1) + '-', '-' + total + '-');
          $(this).attr({'for': forValue});
        }
    });

    
    console.log("Hello world!!!!!!!!!!!!!!!!!")         
  
    total++;
    $('#id_' + prefix + '-TOTAL_FORMS').val(total);
    $(selector).after(newElement);
    var conditionRow = $('.form-row:not(:last)');
    conditionRow.find('.btn.add-form-row')
    .removeClass('btn-success').addClass('btn-danger')
    .removeClass('add-form-row').addClass('remove-form-row')
    .html('-');

    var channel_id = `id_form-${total}-channel` 
    var element_id = `id_form-${total}-element` 
    var duration_id = `id_form-${total}-durations` 
    var duration_in_id = `id_form-${total}-duration_in` 
    var er_id = `id_form-${total}-er` 
    var freq_id = `id_form-${total}-freq` 
    var total_seconds_id = `id_form-${total}-total_seconds` 
    var base_rate_id = `id_form-${total}-base_rate` 
    var total_id = `id_form-${total}-total` 

    document.getElementById(channel_id).style.display = 'block'
    document.getElementById(element_id).style.display = 'block'
    document.getElementById(duration_id).style.display = 'block'
    document.getElementById(duration_in_id).style.display = 'block'
    document.getElementById(er_id).style.display = 'block'
    document.getElementById(freq_id).style.display = 'block'
    document.getElementById(total_seconds_id).style.display = 'block'
    document.getElementById(base_rate_id).style.display = 'block'
    document.getElementById(total_id).style.display = 'block'
    return false;
}
console.log(list_id, '****************************')
// ajax
$('#id_form-0-ref_program_name').change(function (e) {
    afp_program_name = $(this).val();
    console.log("AFP Program Name:",afp_program_name);

});

$('#id_form-0-ref_channels').change(function (e) {
    afp_channel = $(this).val();			
    console.log("AFP Channel:",afp_channel);


    var url = $("#afp_form").attr("url");


          $.ajax({                       // initialize an AJAX request
        url: url,                    // set the url of the request (= localhost:8000/hr/ajax/                    load-br/)
        data: {
            'program_name': afp_program_name , 'channel' :afp_channel      // add the channel and band to the GET                          parameters by default it is GET method
        },
         success: function (data) {   // `data` is the return of the `load_br` view function
            console.log("Data:",data);
            document.getElementById('id_form-0-afp_base_rate').value = data;
      }
     });
});

$('.class_channels').change(function (e) {
    var id_function = e.target.id

    console.log(e.target.id, 'channel id')
      var channel = $(this).val();  
      console.log(channel, 'channel value')
    var element_id = id_function.replace('channel', 'element');
    console.log(element_id, 'element id')
    var element = $(`#${element_id}`).val(); 
    console.log(element, 'element value') 
      if (element){
        var url1 = $("#nfct_form").attr("url");
        var data = {
            'element': element , 'channel' :channel   // add the channel and band to the GET                          parameters by default it is GET method
          }

     $.ajax({                       // initialize an AJAX request
        url: url1,                    // set the url of the request (= localhost:8000/hr/ajax/                    load-br/)
        data: {
          'element': element , 'channel' :channel      // add the channel and band to the GET                          parameters by default it is GET method
        },
         success: function (data) {   // `data` is the return of the `load_br` view function
        var base_id = id_function.replace('channel', 'base_rate')
        console.log("API", data)
        document.getElementById(base_id).value= data;
      }
     });
 
      }                 // storing selected channel in trial variable
    }); 
    
$('.class_element').change(function (e) {
    
    var id_function = e.target.id
    attachevent(id_function)
      var element = $(this).val();  
      console.log(element, 'element value')
    //   channel = $(`#id_form-${add}-channel`).val();
    var channel_id = id_function.replace('element', 'channel')
    console.log(channel_id, 'channel id2')
    var channel = $(`#${channel_id}`).val();  
    console.log(channel, 'channel value 2')
      if (channel){
        var url1 = $("#nfct_form").attr("url");
        console.log(url1, 'url1')
        var data = {
            'element': element , 'channel' :channel      // add the channel and band to the GET                          parameters by default it is GET method
        
      }
      
      $.ajax({                       // initialize an AJAX request
        url: url1,                    // set the url of the request (= localhost:8000/hr/ajax/                    load-br/)
        data: {
          'element': element , 'channel' :channel      // add the channel and band to the GET                          parameters by default it is GET method
        },
      success: function (data) {   // `data` is the return of the `load_br` view function
        
        var base_id = id_function.replace('element', 'base_rate')
        console.log("API2", data)
        document.getElementById(base_id).value= data;
          
        }
    });
    }
});


// ajax

//total and total seconds calculation start

// frequency
$('.class_freq').on('input',function(e)
{
    var freqid_function = e.target.id
    console.log(freqid_function, 'frequency id')
    
    var frequency = $(this).val();
    console.log(frequency, 'freq value')
    var er_id = freqid_function.replace('freq', 'er')
    var er = $(`#${er_id}`).val()
    var tot_sec_id = freqid_function.replace('freq', 'total_seconds')
    var tot_sec = $(`#${tot_sec_id}`).val()

    var total = freqid_function.replace('freq', 'total')
    var element_id = freqid_function.replace('freq', 'element')
    var element = $(`#${element_id}`).val()

    var base_id = freqid_function.replace('freq', 'base_rate')
    var base = $(`#${base_id}`).val()

    if (element === 'Aston' || element === "L Band"){
        document.getElementById(tot_sec_id).value = frequency * 10;
        document.getElementById(total).value = er * (frequency * 10);
    }
    else{
        document.getElementById(total).value = base * frequency;
    }
    

    


})

$('.class_er').on('input',function(e)
{
    var erid_function = e.target.id
    // console.log(erid_function, 'Effective rate id')
    
    var eff_rate = parseInt($(this).val());
    console.log({eff_rate})


    var tot_sec_id = erid_function.replace('er', 'total_seconds')
    var total_sec = $(`#${tot_sec_id}`).val();
    console.log({total_sec})

    var total = erid_function.replace('er', 'total')
    console.log({total})

    document.getElementById(total).value = eff_rate * total_sec;


})


function deleteForm(prefix, btn) {

    var total = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
    if (total > 1){
        btn.closest('.form-row').remove();
        var forms = $('.form-row');
        $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
        for (var i=0, formCount=forms.length; i<formCount; i++) {
            $(forms.get(i)).find(':input').each(function() {
                updateElementIndex(this, prefix, i);
            });
        }
    }
    return false;
}

$(document).on('click', '.add-form-row', function(e){
    e.preventDefault();
    cloneMore('.container1:last', 'form');
    return false;
});

$(document).on('click', '.remove-form-row', function(e){
    e.preventDefault();
    deleteForm('form', $(this));
    return false;
});

    // event listener for onchange to hide or display fields
function attachevent(ele_id){
    console.log(ele_id, 'element id *********')
    console.log('Attach')    
    var durations = ele_id.replace('element', 'durations')
    console.log({durations})
    
    var duration_in = ele_id.replace('element','duration_in')
    console.log({duration_in})
        var elements = document.getElementById(ele_id).value
        console.log(elements, 'elements -------')
        document.getElementById(durations).style.display = 'block'
        document.getElementById(duration_in).style.display = 'block'
        document.getElementById(ele_id.replace('element','er')).style.display = 'block'
        document.getElementById(ele_id.replace('element','total_seconds')).style.display = 'block'

            if (elements === "Aston" || elements === "L Band"){
        document.getElementById(durations).style.display = 'none'
        document.getElementById(duration_in).style.display = 'none'
            }
            else{
            document.getElementById(ele_id.replace('element','er')).style.display = 'none'
            document.getElementById(ele_id.replace('element','total_seconds')).style.display = 'none'
            }
            console.log('inside')
             
    }


</script>

{% endblock %}
</body>