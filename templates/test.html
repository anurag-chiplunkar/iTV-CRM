{% extends "base2.html" %}
{% load crispy_forms_tags %}
{% block container %}
{% if heading %}
{% endif %}
<body>
    <h1><u><center>NFCT Deal Details</center></u></h1>
<form class="form-horizontal" method="POST" id = "nfct_form" action="" url = "{% url 'nfct:nfct_load_br' %}" url1="{% url 'afp_deal:load_afp_client_contacts' %}" url2="{% url 'afp_deal:load_afp_agency_contacts' %}">
    {% csrf_token %}
    <!-- deal id -->
<div class="row form-row spacer">
   
    <div class="col-4">
        <div>
            <label>Deal Id</label>
        </div>
        <div class="input-group" >
            {{form.deal_id}}
            
        </div>
    </div>
</div>
    <br>
    
    <div class="row mb-3">
        <!-- salesperson input -->
        <div class="col-6">
            <div class="row">
                <div class="col-auto">
                    <label for="salesperson" class="col-form-label">Executive</label>
                </div>
                <div class="col-auto">
                    {% for j in qs1 %}
                    
                        <input type="text" name="executive" id="salesperson" class="form-control" value='{{j.emp_fname}} {{j.emp_lname}}' readonly>
                    {% endfor %}
                </div>
            </div> 
        </div>

        <!-- Reporting manager input -->
         <div class="col-6">
            <div class="row">
                <div class="col-auto">
                    <label for="report" class="col-form-label">Reporting Manager</label>
                </div>
                <div class="col-auto">
                    {% for k in qs1 %}
                    
                        <input type="text" name="reporting_manager" id="reporting" class="form-control" value='{{k.emp_reporting_mgr}}' readonly>
                    {% endfor %}
                </div>
            </div>
        </div> 
    </div>

    <!-- RO -->
    <div class="row mb-3">
        <!-- RO Number input -->
        <div class="col-6">
            <div class="row">
                <div class="col-auto">
                    <label for="RO Number" class="col-form-label">RO Number</label>
                </div>
                <div class="col-auto">
                    {{form.RO_number}}
                </div>
            </div> 
        </div>

        <!-- RO Value input -->
         <div class="col-6">
            <div class="row">
                <div class="col-auto">
                    <label for="RO Value" class="col-form-label">RO Value</label>
                </div>
                <div class="col-auto">
                    {{form.RO_value}}
                </div>
            </div>
        </div> 
    </div>

    <!-- client name dropdown -->
    <div class="row mb-3">
        <div class="col-3">
            <div class="row">
                <div class="col-auto">
                    <label for="client_name" class="col-form-label">Client Name</label>
                </div>
                <div> 
                    {{form.client_name_ref}}
                </div>
                    
                </div>
            </div>
        <!-- </div> -->

        <!-- agency name dropdown -->
        <div class="col-3 offset-3">
            <div class="row mb-6">
                <div class="col-auto">
                    <label for="agency_name" class="col-form-label">Agency Name</label>
                </div>
                <div>
                    {{form.agency_name_ref}}
                </div>
                
            </div>
        </div>
    </div>

    <!-- brand name dropdown -->
    <div class="row mb-3">
        <div class="col-3">
            <div class="row mb-6">
                <div class="col-auto">
                    <label for="brand_name" class="col-form-label">Brand Name</label>
                </div>
                <div>
                    {{form.brand_name_ref}}
                </div>
            </div>
        </div> 
        
    </div>

    <div class="row mb-3 mt-5">
        <!-- client contact details -->
        <div class="col-6">
            <div class="col-auto">
                <h5><b><label for="client_contact" class="col-form-label">Client Contact Details</label></b></h5>
            </div>
            <div class="col-auto">
                <table class="table table-hover">
                    <thead>
                            <tr>
                               
                                <th scope="col">
                                    Name
                                </th>
                                <th scope="col">
                                    Designation
                                </th>
                                <th scope="col">
                                    Email
                                </th>
                                <th scope="col">
                                    Telephone
                                </th>
                            </tr>
                    </thead>
                    <tbody>
                        <tr class="col-auto">
                            <th scope="row" class="col-3">
                                {{form.client_contact_ref}}
                            </th>
                            <td><input type="text" name="clientdesignation" id="clientdesignation" class="form-control" readonly></td>
                            <td><input type="email" name="clientemail" id="clientemail" class="form-control" readonly></td>
                            <td><input type="tele" name="clienttele" id="clienttele" class="form-control" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- agency contact details -->
        <div class="col-6">
            <div class="col-auto">
                <h5><b><label for="client_contact" class="col-form-label">Agency Contact Details</label></b></h5>
            </div>
            <div class="col-auto">
                <table class="table table-hover">
                    <thead>
                            <tr>
                                <!-- <th scope="col"></th> -->
                                <th scope="col">
                                    Name
                                </th>
                                <th scope="col">
                                    Designation
                                </th>
                                <th scope="col">
                                    Email
                                </th>
                                <th scope="col">
                                    Telephone
                                </th>
                            </tr>
                    </thead>
                    <tbody>
                        <tr  class="col-auto">
                            <th scope="row"  class="col-3">
                                {{form.agency_contact_ref}}
                             
                        </th>
                            <td><input type="text" name="agencydesignation" id="agencydesignation" class="form-control" readonly></td>
                            <td><input type="email" name="agencyemail" id="agencyemail" class="form-control" readonly></td>
                            <td><input type="tele" name="agencytele" id="agencytele" class="form-control" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <hr>
    {{ formset.management_form }}
    {% for form in formset %}



<!-- assign all the columns of formset to container -->

<div class="container1">
    <hr>
    <!-- first row -->
    <div class="row form-row spacer">
      
        <div class="col-3">
            <div>
                <label>Channel</label>
            </div>
            <div class="input-group form-select col-auto ">
                {{form.channel}}
                
            </div>
        </div>
        <div class="col-3">
            <div>
                <label>Element</label>
            </div>
            <div class="input-group form-select col-auto">
                {{form.element}}
                
            </div>
        </div>
        <div class="col-3" id="div_duration">
            <div>
                <label>Durations</label>
            </div>
            <div class="input-group form-select col-auto class_durations">
                {{form.durations}}  
            </div>
        </div>
        <div class="col-3" id="div_duration_in">
            <div>
                <label>Duration In</label>
            </div>
            <div class="input-group form-select col-auto class_duration_in">
                {{form.duration_in}}
                
            </div>
        </div>
        
    </div>

    <!-- second row -->
    <div class="row form-row spacer">
    
        <div class="col-3" id="div_effective_rate">
            <div>
                <label>Effective Rate</label>
            </div>
            <div class="input-group">
                {{form.er}}
                
            </div>
        </div>
        <div class="col-3">
            <div>
                <label>Frequency</label>
            </div>
            <div class="input-group">
                {{form.freq}}
                
            </div>
        </div>
        <div class="col-3" id="div_total_seconds">
            <div>
                <label>Total Seconds</label>
            </div>

            <div class="input-group">
                {{form.total_seconds}}
                <!-- <input type="number" id="id_form-0-total_seconds" value='{{obj_nfctmodel.total_seconds}}' name="id_form-0-total_seconds" class="form-control"> -->
                
            </div>
        </div>
        <div class="col-3">
            <div>
                <label>Base Rate</label>
            </div>
            <div class="input-group">
                {{form.base_rate}}
                <!-- <input type="number" id="baserate1" value='{{nfctbaserate}}' name="baserate1" class="form-control class_baserate"> -->
            </div>
        </div>
        
    </div>

    <!-- total -->
    <div class="row form-row spacer">
        <div class="col-3">
            <div>
                <label>Total</label>
            </div>
            <div class="input-group class_total">
                {{form.nfct_total}}
                
            </div>
        </div>
        
          
        
    </div>


       

     
</div>

<hr>
{% endfor %}
<div class="row form-row spacer">
    <div class="col-3">
        <div>
            <label>Grand Total</label>
        </div>
        <div class="input-group">
        <input type = "text" placeholder="Grand Total" id="id_nfct_grandtotal" name="nfct_grandtotal" class="form-control">
            
        </div>
        <br>
       
    </div>
    </div>
<!--Buttons -->

<div class="row spacer">
    <div class="col-auto">
        <!-- <button class="btn btn-primary" id="cal">Calculate Grand Total</button> -->
        <input type="button" class="btn btn-primary" id="cal" value="Calculate Grand Total">
    </div>
    <div class="col-auto input-group-append">
        <button class="btn btn-primary add-form-row" id="add_form">Add Another Element</button>
    </div>
    
    <div class="col-auto">
        <button type="submit" class="btn btn-block btn-primary">Create</button>
    </div>
    <div class="col-auto">
    {% if user.is_authenticated %}
    <button name="submit" type="submit" class="btn btn-primary"><a href="{% url 'profile' %}" style="color: white; text-decoration-line: none;">Back</a></button>
    {% endif %}
    </div>
</div>

</form>

{% endblock %}


<!-- Handles new form instance -->
{% block custom_js %}
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/javascript">
 var count = 0;

//  update element function
function updateElementIndex(el, prefix, ndx) {
    var id_regex = new RegExp('(' + prefix + '-\\d+)');
    var replacement = prefix + '-' + ndx;
    if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
    if (el.id) el.id = el.id.replace(id_regex, replacement);
}
var list_id = []

// clone function
function cloneMore(selector, prefix) {
    
    var newElement = $(selector).clone(true);
    console.log(newElement, 'newElement')
    var total = $('#id_' + prefix + '-TOTAL_FORMS').val();
    // newElement.attr('hidden', false)
    // newElement.removeClass('container-duplicate')
    // newElement.attr('class', `container_${count}`)
    // count++;

    newElement.find(':input:not([type=button]):not([type=submit]):not([type=reset])').each(function() {
        var name = $(this).attr('name')
        
        if(name) {
            name = name.replace('-' + (total-1) + '-', '-' + total + '-');
            var id = 'id_' + name;
            // console.log(id)
            list_id.push(id)
            $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
        }
    });
    console.log(list_id)

    newElement.find('label').each(function() {
        var forValue = $(this).attr('for');
        if (forValue) {
          forValue = forValue.replace('-' + (total-1) + '-', '-' + total + '-');
          $(this).attr({'for': forValue});
        }
    });

    
    console.log("Hello world!!!!!!!!!!!!!!!!!")          // global variable for storing channel
  
    total++;
    $('#id_' + prefix + '-TOTAL_FORMS').val(total);
    $(selector).after(newElement);
    var conditionRow = $('.form-row:not(:last)');
    conditionRow.find('.btn.add-form-row')
    .removeClass('btn-success').addClass('btn-danger')
    .removeClass('add-form-row').addClass('remove-form-row')
    .html('-');

    var channel_id = `id_form-${total}-channel` 
    var element_id = `id_form-${total}-element` 
    var duration_id = `id_form-${total}-durations` 
    var duration_in_id = `id_form-${total}-duration_in` 
    var er_id = `id_form-${total}-er` 
    var freq_id = `id_form-${total}-freq` 
    var total_seconds_id = `id_form-${total}-total_seconds` 
    var base_rate_id = `id_form-${total}-base_rate` 
    var total_id = `id_form-${total}-total` 

    document.getElementById(channel_id).style.display = 'block'
    document.getElementById(element_id).style.display = 'block'
    document.getElementById(duration_id).style.display = 'block'
    document.getElementById(duration_in_id).style.display = 'block'
    document.getElementById(er_id).style.display = 'block'
    document.getElementById(freq_id).style.display = 'block'
    document.getElementById(total_seconds_id).style.display = 'block'
    document.getElementById(base_rate_id).style.display = 'block'
    document.getElementById(total_id).style.display = 'block'
    return false;
}
console.log(list_id, '****************************')
// ajax


// on change channel
$('.class_channel').change(function (e) {
    var id_function = e.target.id

    console.log(e.target.id, 'channel id')
      var channel = $(this).val();  
      console.log(channel, 'channel value')
    //   element = $('.class_element').val();
    var element_id = id_function.replace('channel', 'element');
    console.log(element_id, 'element id')
    var element = $(`#${element_id}`).val(); 
    console.log(element, 'element value') 
      if (element){
        var url1 = $("#nfct_form").attr("url");
        var data = {
            'element': element , 'channel' :channel   // add the channel and band to the GET                          parameters by default it is GET method
          }

     $.ajax({                       // initialize an AJAX request
        url: url1,                    // set the url of the request (= localhost:8000/hr/ajax/                    load-br/)
        data: {
          'element': element , 'channel' :channel      // add the channel and band to the GET                          parameters by default it is GET method
        },
         success: function (data) {   // `data` is the return of the `load_br` view function
        var base_id = id_function.replace('channel', 'base_rate')
        console.log("API", data)
        document.getElementById(base_id).value= data;
      }
     });
 
      }                 // storing selected channel in trial variable
    }); 
    
// on change element
$('.class_element').change(function (e) {
    
    var id_function = e.target.id
    attachevent(id_function)
      var element = $(this).val();  
      console.log(element, 'element value')
    //   channel = $(`#id_form-${add}-channel`).val();
    var channel_id = id_function.replace('element', 'channel')
    console.log(channel_id, 'channel id2')
    var channel = $(`#${channel_id}`).val();  
    console.log(channel, 'channel value 2')
      if (channel){
        var url1 = $("#nfct_form").attr("url");
        console.log(url1, 'url1')
        var data = {
            'element': element , 'channel' :channel      // add the channel and band to the GET                          parameters by default it is GET method
        
      }
      
      $.ajax({                       // initialize an AJAX request
        url: url1,                    // set the url of the request (= localhost:8000/hr/ajax/                    load-br/)
        data: {
          'element': element , 'channel' :channel      // add the channel and band to the GET                          parameters by default it is GET method
        },
      success: function (data) {   // `data` is the return of the `load_br` view function
        
        var base_id = id_function.replace('element', 'base_rate')
        console.log("API2", data)
        document.getElementById(base_id).value= data;
          
        }
    });
    }
});


// frequency calculation
$('.class_freq').on('input',function(e)
{
    var freqid_function = e.target.id
    console.log(freqid_function, 'frequency id')
    
    var frequency = $(this).val();
    console.log(frequency, 'freq value')
    var er_id = freqid_function.replace('freq', 'er')
    var er = $(`#${er_id}`).val()
    var tot_sec_id = freqid_function.replace('freq', 'total_seconds')
    var tot_sec = $(`#${tot_sec_id}`).val()

    console.log('##########################')
    var total = freqid_function.replace('freq', 'nfct_total')
    console.log($(`#${total}`).val())
    var element_id = freqid_function.replace('freq', 'element')
    var element = $(`#${element_id}`).val()

    var base_id = freqid_function.replace('freq', 'base_rate')
    var base = $(`#${base_id}`).val()

    if (element === 'Aston' || element === "L Band"){
        document.getElementById(tot_sec_id).value = frequency * 10;
        document.getElementById(total).value = (er * (frequency * 10))/10;
        // grand_total = document.getElementById(total).value = (er * (frequency * 10))/10;
    }
    else{
        document.getElementById(total).value = base * frequency;
    }
    
})

// effective rate calculation
$('.class_er').on('input',function(e)
{
    var erid_function = e.target.id
    console.log(erid_function, 'Effective rate id')
    
    var eff_rate = parseInt($(this).val());
    console.log({eff_rate})


    var tot_sec_id = erid_function.replace('er', 'total_seconds')
    var total_sec = $(`#${tot_sec_id}`).val();
    console.log({total_sec})

    var total = erid_function.replace('er', 'nfct_total')
    document.getElementById(total).value = eff_rate * total_sec;


})

// add more
$(document).on('click', '.add-form-row', function(e){
    e.preventDefault();
    cloneMore('.container1:last', 'form');
    return false;
});

// remove more
$(document).on('click', '.remove-form-row', function(e){
    e.preventDefault();
    deleteForm('form', $(this));
    return false;
});

    // event listener for onchange to hide or display fields
function attachevent(ele_id){
    console.log(ele_id, 'element id *********')
    console.log('Attach')    
    var durations = ele_id.replace('element', 'durations')
    console.log({durations})
    
    var duration_in = ele_id.replace('element','duration_in')
    console.log({duration_in})
        var elements = document.getElementById(ele_id).value
        console.log(elements, 'elements -------')
        document.getElementById(durations).style.display = 'block'
        document.getElementById(duration_in).style.display = 'block'
        document.getElementById(ele_id.replace('element','er')).style.display = 'block'
        document.getElementById(ele_id.replace('element','total_seconds')).style.display = 'block'

            if (elements === "Aston" || elements === "L Band"){
        document.getElementById(durations).style.display = 'none'
        document.getElementById(duration_in).style.display = 'none'
            }
            else{
            document.getElementById(ele_id.replace('element','er')).style.display = 'none'
            document.getElementById(ele_id.replace('element','total_seconds')).style.display = 'none'
            }
            console.log('inside')
             
    }

// grandtotal
$('#cal').on('click',function(e){
    var gtid = e.target.id

    console.log(gtid, '5555555555555')
    var total_forms_id = gtid.replace('cal', 'id_form-TOTAL_FORMS')
    var total_forms = $(`#${total_forms_id}`).val();
    console.log(total_forms)
    var total_id = gtid.replace('cal', 'id_form-0-nfct_total')
    console.log(total_id)
    var total = $(`#${total_id}`).val();
    console.log(total)
    
    var grandtotal = 0
    for(i = 0; i<=parseInt(total_forms); i++){
        console.log('i', i)
        console.log('grandtotal', grandtotal)
        $("#id_nfct_grandtotal").val(parseInt(grandtotal)) 
        grandtotal = parseInt(grandtotal)+ parseInt($(`#id_form-${i}-nfct_total`).val())
        console.log('grandtotal after', grandtotal) 
    }
  
})


    const uid = 'NFCTDeal' + Date.now(); 
    document.getElementById("id_deal_id").value = uid;


    $("#id_client_name_ref").change(function () {
        var url = $("#nfct_form").attr("url1");  // get the url of the 'load_client_contacts' view
        var clientId = $(this).val();  // get the selected client contact ID from the HTML input
        console.log("client id:",clientId);
        console.log("url:",url);
        $.ajax({                       // initialize an AJAX request
            url: url,                    // set the url of the request (= localhost:8000/hr/ajax/load-cities/)
            data: {
            'client': clientId       // add the contact id to the GET parameters
            },
            success: function (data) {
                console.log(data);   // `data` is the return of the `load_client_contacts` view function
                $("#id_client_contact_ref").html(data);  // replace the contents of the client contact input with the data that came from the server
           
            }
        });

    });

    $("#id_agency_name_ref").change(function () {
        var url = $("#nfct_form").attr("url2");  // get the url of the 'load_client_contacts' view
        var agencyId = $(this).val();  // get the selected client contact ID from the HTML input
        console.log("agency id:",agencyId);
        console.log("url:",url);
        $.ajax({                       // initialize an AJAX request
            url: url,                    // set the url of the request (= localhost:8000/hr/ajax/load-cities/)
            data: {
            'agency': agencyId       // add the contact id to the GET parameters
            },
            success: function (data) {
                console.log(data);   // `data` is the return of the `load_client_contacts` view function
                $("#id_agency_contact_ref").html(data);  // replace the contents of the client contact input with the data that came from the server
           
            }
        });

    });



</script>

<script>

    // on change client contact JSON
    var cli_contact = '{{ tmpJson | safe }}';
	$("#id_client_name_ref").change(function () {
		
		var client = $(this).val();			
	});	

    // on change auto display
	$("#id_client_contact_ref").change(function(){
		var c_con_name = $(this).val();	
		var client = $('#id_client_name_ref').val();
		console.log("----------",c_con_name,client);
		if(c_con_name){
			doc_cli = new DOMParser().parseFromString(cli_contact, "text/html")
			cli_list = doc_cli.documentElement.textContent;
			cli_list = JSON.parse(cli_list)
            for (i=0;i<cli_list.length;i++){      //iterating in the list of dictionary
                var field = cli_list[i]['fields'];    //storing the fields key of the ith element
                    if (c_con_name == cli_list[i]['pk']){    //if the selected contact name is equal to the pk of the ith ele
                        var des = cli_list[i]['fields']['pri_desg'];
                        var ema = cli_list[i]['fields']['pri_email'];
                        var tele = cli_list[i]['pk'];
                        document.getElementById('clientdesignation').value = des;
                        document.getElementById('clientemail').value = ema;
                        document.getElementById('clienttele').value = tele;

		}}}
	});

	var ag_contact = '{{ tmpagen | safe }}';

    // onchange agency JSON
	$("#id_agency_name_ref").change(function(){
		var agency = $(this).val();
	});

    // on change auto display
	$("#id_agency_contact_ref").change(function(){
		var a_con_name = $(this).val();
		var agency = $('#id_agency_name_ref').val();
		if(a_con_name){
			doc_agn = new DOMParser().parseFromString(ag_contact, "text/html")
			agn_list = doc_agn.documentElement.textContent;
			agn_list = JSON.parse(agn_list)
            for (i=0;i<agn_list.length;i++){
                var field = agn_list[i]['fields'];
                    if (a_con_name == agn_list[i]['pk']){
                        var des = agn_list[i]['fields']['pri_designation']
                        var ema = agn_list[i]['fields']['pri_email']
                        var tele = agn_list[i]['pk']
                        document.getElementById('agencydesignation').value = des
                        document.getElementById('agencyemail').value = ema
                        document.getElementById('agencytele').value = tele
                    }
                
            }
          
		}
	});
</script>




{% endblock %}
</body>